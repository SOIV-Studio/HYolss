# 실시간 트위터 Discord 알림 봇 개발 계획서

## 📋 프로젝트 개요

### 목표
X(트위터) API v2 Filtered Stream을 활용하여 **진짜 실시간** 트윗 알림을 Discord로 전송하는 봇 개발

### 핵심 차별점
- ⚡ **폴링 방식 → 실시간 스트리밍**: 30초~5분 지연 → 즉시 알림
- 🤖 **지능형 자가 치유**: 90% 에러 자동 해결로 개발자 개입 최소화
- 💰 **효율적 API 사용**: Heartbeat 활용으로 불필요한 API 호출 제거

---

## 🏗️ 시스템 아키텍처

### 1. 핵심 컴포넌트

```
┌─────────────────┐    ┌──────────────────┐    ┌────────────────┐
│   X API v2      │ -> │  Stream Manager  │ -> │ Discord Guilds │
│ Filtered Stream │    │ (Heartbeat 기반) │    │   (다중 서버)  │
└─────────────────┘    └──────────────────┘    └────────────────┘
                              |
                       ┌──────────────────┐
                       │ Error Handler    │
                       │ (자동 해결)      │
                       └──────────────────┘
                              |
                       ┌──────────────────┐
                       │ Developer Alert  │
                       │ (Discord Webhook)│
                       └──────────────────┘
```

### 2. 데이터 흐름

1. **필터 규칙 설정** → X API에 모니터링할 계정/키워드 등록
2. **실시간 스트림 수신** → 조건에 맞는 트윗 + Heartbeat 신호
3. **지능형 처리** → 트윗 파싱, 서버별 설정 적용, Discord 전송
4. **자동 장애 관리** → 에러 감지, 자동 해결, 개발자 알림

---

## 🔧 기술 구현 세부사항

### 1. X API Filtered Stream 관리

#### Heartbeat 기반 연결 모니터링
```javascript
// 핵심 원리
- X API가 20초마다 '\r\n' 신호 전송
- 40초간 신호 없으면 연결 문제로 판단
- 즉시 재연결 시도 (12시간 vs 40초!)
```

#### 스트림 데이터 처리
```javascript
stream.on('data', (chunk) => {
    if (chunk === '\r\n') {
        // Heartbeat 신호 - 연결 정상
        updateLastHeartbeat();
    } else {
        // 실제 트윗 데이터 처리
        handleTweet(JSON.parse(chunk));
    }
});
```

### 2. 지능형 에러 처리 시스템

#### 자동 해결 가능한 에러들
| 에러 타입 | 자동 해결 방법 | 심각도 |
|-----------|----------------|--------|
| `ECONNRESET` | 점진적 백오프 재연결 | 3/10 |
| `ETIMEDOUT` | 타임아웃 값 증가 후 재연결 | 4/10 |
| `rate_limit` | Rate limit 리셋까지 대기 | 6/10 |
| `invalid_rules` | 안전한 기본 규칙으로 복원 | 8/10 |
| `memory_leak` | 가비지 컬렉션 + 리소스 정리 | 9/10 |
| `heartbeat_timeout` | 즉시 재연결 | 5/10 |

#### 점진적 백오프 알고리즘
```javascript
const delay = Math.min(2000 * Math.pow(2, attempts), 30000);
// 2초 → 4초 → 8초 → 16초 → 30초 (최대)
```

### 3. 개발자 알림 시스템

#### 알림 조건
- 심각도 7/10 이상 에러
- 자동 해결 실패한 에러
- 일일 자동 수정 시도 5회 초과

#### 알림 내용
- 에러 타입 및 심각도
- 자동 해결 시도 결과
- 상세 컨텍스트 정보
- 시간 정보

---

## 📊 API 사용량 및 비용 분석

### 1. X API v2 플랜별 제한

| 플랜 | 월 비용 | 읽기 한도 | Filtered Stream | 권장 사용 |
|------|---------|-----------|-----------------|-----------|
| **Free** | $0 | 50개 | ❌ | 테스트용 |
| **Basic** | $200 | 15,000개 | ✅ | 소규모 (5-10 계정) |
| **Pro** | $5,000 | 1,000,000개 | ✅ | 대규모 (수백 계정) |

### 2. 실제 사용량 계산

```javascript
// 예시: 5개 활발한 계정 모니터링
const dailyTweets = {
    'elonmusk': 10,
    'sama': 5, 
    'naval': 3,
    'paulg': 4,
    'pmarca': 8
};

// 월간 예상 소비: (10+5+3+4+8) × 30 = 900개
// Basic 플랜(15,000개)으로 충분!
```

### 3. API 호출 최적화

#### 기존 폴링 방식
```javascript
// 비효율적
매 30초마다 API 호출 × 계정 수 × 24시간 × 30일
= 30초 간격으로 5계정 = 월 432,000회 호출
```

#### 새로운 스트리밍 방식
```javascript
// 효율적
초기 설정: 2-3회 API 호출
이후: X가 데이터 푸시 (추가 호출 없음)
소비: 받은 트윗 개수만큼만 차감
```

---

## 🛠️ 개발 단계별 계획

### Phase 1: 핵심 기능 구현 (2주)

#### Week 1: 기본 스트리밍 시스템
- [ ] X API v2 인증 및 연결
- [ ] Filtered Stream 기본 구현
- [ ] Heartbeat 모니터링 시스템
- [ ] 기본 Discord 메시지 전송

#### Week 2: 안정성 강화
- [ ] 재연결 로직 구현
- [ ] 기본 에러 처리
- [ ] 로깅 시스템
- [ ] 메모리 관리

### Phase 2: 지능형 시스템 (2주)

#### Week 3: 에러 처리 고도화
- [ ] 에러 자동 분류 시스템
- [ ] 자동 해결 전략 구현
- [ ] 점진적 백오프 알고리즘
- [ ] 자동 메모리 관리

#### Week 4: 개발자 도구
- [ ] Discord 웹훅 알림 시스템
- [ ] 상세 로깅 및 분석
- [ ] 시스템 상태 모니터링
- [ ] 성능 최적화

### Phase 3: 고급 기능 (2주)

#### Week 5: 사용자 경험 개선
- [ ] 서버별 설정 시스템
- [ ] 커스텀 메시지 포맷
- [ ] 필터링 옵션
- [ ] 관리자 명령어

#### Week 6: 배포 및 운영
- [ ] Docker 컨테이너화
- [ ] CI/CD 파이프라인
- [ ] 문서 작성
- [ ] 부하 테스트

---

## 🎯 주요 기능 명세

### 1. 실시간 트윗 모니터링

#### 지원 필터 타입
```javascript
const filterRules = [
    { value: 'from:username -is:retweet', tag: 'user-tweets' },
    { value: '#hashtag lang:ko', tag: 'korean-hashtags' },
    { value: 'keyword1 OR keyword2', tag: 'keywords' },
    { value: 'from:user has:images', tag: 'user-media' }
];
```

#### Discord 메시지 포맷
- 트윗 내용 및 메타데이터
- 작성자 정보 (프로필 이미지, 인증 배지)
- 상호작용 지표 (좋아요, 리트윗, 댓글)
- 원본 트윗 링크
- 타임스탬프

### 2. 서버별 설정 관리

#### 설정 가능한 옵션
- 모니터링할 계정/키워드 목록
- 알림 채널 지정
- 메시지 포맷 커스터마이징
- 필터링 규칙 (RT 제외, 미디어만 등)
- 알림 주기 제한 (스팸 방지)

### 3. 관리자 명령어

```bash
/twitter add @username        # 계정 추가
/twitter remove @username     # 계정 제거
/twitter list                 # 모니터링 목록
/twitter status              # 봇 상태 확인
/twitter settings            # 설정 관리
```

---

## 🔒 보안 및 안정성

### 1. API 키 관리
- 환경 변수를 통한 민감 정보 분리
- 키 로테이션 지원
- 권한 최소화 원칙

### 2. Rate Limit 관리
- 자동 Rate Limit 감지 및 대기
- 사용량 모니터링 및 알림
- 비상시 자동 규칙 비활성화

### 3. 장애 복구
- 자동 재연결 메커니즘
- 데이터 손실 방지
- 백업 연결 옵션 (향후 구현)

---

## 📈 모니터링 및 분석

### 1. 시스템 메트릭
- 업타임 및 연결 상태
- 메모리 사용량
- 처리된 트윗 수
- 에러 발생률 및 자동 해결률

### 2. 성능 지표
- 평균 지연 시간
- API 사용량 추이
- Discord 메시지 전송 성공률
- 사용자 서버 수 및 활성도

### 3. 알림 및 리포트
- 일일/주간/월간 리포트
- 임계치 초과 시 자동 알림
- 트렌드 분석 및 최적화 제안

---

## 🚀 향후 확장 계획

### 단기 목표 (3개월)
- [ ] 멀티 플랫폼 지원 (YouTube, Instagram)
- [ ] 웹 대시보드 구현
- [ ] 모바일 푸시 알림 연동
- [ ] AI 기반 트윗 분류

### 중기 목표 (6개월)
- [ ] 사용자 구독 모델
- [ ] 고급 분석 대시보드
- [ ] API 서비스 제공
- [ ] 다국어 지원

### 장기 목표 (1년)
- [ ] 엔터프라이즈 솔루션
- [ ] 머신러닝 기반 개인화
- [ ] 크로스 플랫폼 통합 분석
- [ ] 실시간 트렌드 예측

---

## 💡 기술적 고려사항

### 1. 확장성
- 마이크로서비스 아키텍처 전환 준비
- 데이터베이스 샤딩 계획
- 로드 밸런싱 전략
- 캐싱 시스템 도입

### 2. 성능 최적화
- 메모리 풀링
- 연결 재사용
- 비동기 처리 최적화
- 불필요한 API 호출 제거

### 3. 운영 편의성
- Health Check 엔드포인트
- 설정 Hot Reload
- 무중단 배포 지원
- 로그 중앙화

---

## 📝 개발 규칙 및 가이드라인

### 1. 코딩 표준
- ESLint + Prettier 설정
- JSDoc 주석 필수
- 단위 테스트 커버리지 80% 이상
- Git 커밋 메시지 컨벤션

### 2. 에러 처리 원칙
- 모든 에러는 분류되어야 함
- 자동 해결 가능한 에러는 최대 5회까지 시도
- 심각도 7 이상은 즉시 개발자 알림
- 모든 에러는 로깅되어야 함

### 3. 테스트 전략
- 단위 테스트: Jest
- 통합 테스트: X API 모킹
- 부하 테스트: 대량 트윗 시뮬레이션
- 장애 테스트: 연결 끊김 시나리오

---

## 📚 참고 자료

### API 문서
- [X API v2 Documentation](https://docs.x.com/x-api)
- [Filtered Stream Guide](https://docs.x.com/x-api/posts/filtered-stream)
- [Discord.js Documentation](https://discord.js.org/)

### 모니터링 도구
- Node.js 내장 `process.memoryUsage()`
- Discord 웹훅을 통한 실시간 알림
- 커스텀 대시보드 (향후 구현)

### 배포 환경
- Docker + Docker Compose
- PM2 프로세스 관리
- Nginx 리버스 프록시
- Let's Encrypt SSL

---

## ✅ 체크리스트

### 개발 전 준비사항
- [ ] X Developer 계정 생성
- [ ] API 키 발급 (Basic/Pro 플랜)
- [ ] Discord 봇 토큰 생성
- [ ] 개발 환경 설정 (Node.js, Git)
- [ ] 테스트 서버 준비

### 배포 전 확인사항
- [ ] 모든 환경 변수 설정
- [ ] API 키 권한 확인
- [ ] 메모리 제한 설정
- [ ] 로그 로테이션 설정
- [ ] 모니터링 도구 연동

### 운영 중 관리사항
- [ ] 일일 상태 리포트 확인
- [ ] 주간 사용량 분석
- [ ] 월간 비용 리뷰
- [ ] 분기별 성능 최적화

---

*이 계획서는 실시간 트위터 Discord 알림 봇의 전체적인 개발 및 운영 방향을 제시합니다. 각 단계별 구현 시 이 문서를 참조하여 일관성 있는 개발을 진행해주세요.*