# 📑 AI 채팅 시스템 설계 문서

## 1. 프로젝트 개요
- **프로젝트명**: Ayaka Project(from. HYolss Project)
- **목표**: 단일 AI 채팅 시스템이 아닌, **뉴로사마(Neurosama)와 같은 성격이 부여된 AI 버튜버 시스템** 구축
- **작업 순서**: 모든 다른 기능 작업 완료 후 마지막으로 본 기능 제작 예정

---

## 2. 기능 개요
### 2.1 핵심 기능
- **AI 채팅 시스템** (성격 기반, 롤플레잉 지원)
- **인연 랭크 시스템** (키즈나 랭크/KIZUNA RANK/キズナランク)
  - 유저와 캐릭터간의 인연 랭크 시스템
  - 랭크 상승 시 서비스 관련 아이템 획득 가능
- **상점 기능**
  - 봇과 연결된 웹사이트에서 이용 가능
  - 아이템 구매 및 랭크와 연동된 보상 획득
- **간단한 게임 기능**
  - 채팅 기반 미니게임 또는 소셜 기능

### 2.2 외부 기능 연동
- Google Search (제한적 검색)
- 번역 (Translate)

### 2.3 제외 범위
- **Live2D/아바타 시스템**: 서버 및 작업량 부담으로 제외
- **정식 TTS**: 테스트 가능하나 정식 적용 X (보이스팩/보컬로이드 필요 → 예산 문제)
- **딥러닝 기반 게임 플레이**: 뉴로사마에 충분히 구현되어 있음, 본 프로젝트는 채팅 중심

---

## 3. AI 모델 및 학습 전략
### 3.1 모델 선택
- **후보 모델**: Gemini, GPT-4/5, Claude, LLaMA, 기타 LLM
- **계획**: API 사용 또는 자체 LLM 운영 여부 결정 필요

### 3.2 데이터셋 구축
- 캐릭터 성격 기반 대화 데이터
- 롤플레잉 시나리오 스크립트
- 멀티턴 대화 예시
- 금칙어/필터링 데이터셋

### 3.3 모델 학습 및 평가
- 파인튜닝 / Few-shot 프롬프트 설계
- 하이퍼파라미터 최적화
- 성능 메트릭 정의 (정확성, 맥락 유지, 사용자 만족도)
- A/B 테스트 계획

---

## 4. 대화 및 컨텍스트 관리
- **대화 기록 저장 및 관리**
- **컨텍스트 윈도우 최적화** (최근 대화 위주로 유지, 장기 기억은 별도 저장)
- **메모리 관리 전략** (단기/장기 기억 구분)
- **세션 관리 정책** (시간 초과 시 세션 초기화 등)

---

## 5. 데이터 수집 및 활용
### 5.1 수집 데이터 항목
- **유저 입력 데이터**: 사용자 메시지
- **AI 응답 데이터**: 출력 결과, 품질 평가 지표
- **메타데이터**: 유저 ID(익명화 가능), 시간, 서버/채널 ID
- **반응 데이터**: 이모지 반응, 후속 대화 여부
- **시스템 로그**: 응답 속도, 오류 발생, API 호출 실패

### 5.2 활용 방안
- **필터링 고도화**: 욕설/스팸 패턴 학습
- **품질 개선**: 자주 틀린 질문 유형 파악, 프롬프트 보완
- **비용 최적화**: 반복 응답 캐싱, 간단 질문은 무료 모델 활용
- **사용자 경험 향상**: 만족도 높은 응답 패턴 분석 → 캐릭터 성격 튜닝

---

## 6. 토큰 및 비용 관리
- **사용량 모니터링 시스템** (API 호출 수, 토큰 단위 추적)
- **사용자별/서버별 할당량 설정** (쿼터 제어)
- **비용 최적화 전략** (캐시 시스템, 무료+유료 하이브리드 운영)
- **응답 캐시 시스템** 구현

---

## 7. 안전성 및 필터링
- **콘텐츠 필터링 시스템** (욕설, 불법/민감 콘텐츠 차단)
- **악의적 입력 방지** (프롬프트 인젝션 방어)
- **응답 검증 로직** (출력 후 검증 → 문제 시 대체 응답 사용)
- **긴급 중단 시스템** (관리자 개입 가능)

---

## 8. 성능 최적화
- **응답 시간 최적화** (모델 캐싱, 비동기 요청)
- **배치 처리 구현** (여러 요청 묶어서 처리)
- **로드 밸런싱 전략** (다중 서버 트래픽 분산)
- **분산 처리 시스템** (확장성 대비)

---

## 9. 통합 AI 시스템
- **명령어 의도 파악** (자연어 입력 → 명령/대화 구분)
- **자연어 명령 처리** (봇 제어, 기능 실행)
- **컨텍스트 기반 추천** (상황 맞춤 응답)
- **멀티모달 지원 (장기 계획)**
  - 이미지 인식/생성
  - 음성 인식/합성
  - 감정 분석

---

## 10. 운영 및 향후 확장
- **MVP 단계**: 무료 API 기반 간단 AI 채팅 + 인연 랭크/상점
- **정식 단계**: 유료 모델 전환, 데이터 기반 필터링 강화, 기능 확장
- **장기 목표**: 멀티모달 지원, 캐릭터 성격 및 스토리 확장

---

# 🗄️ AI 채팅 시스템 DB 설계

## 1. 주요 테이블 개요
- **Users**: 디스코드 유저 관리
- **Servers**: 디스코드 서버 관리
- **UserStats**: 유저별 인연 랭크, 경험치 관리
- **ChatLogs**: 채팅 기록 저장
- **AIResponses**: AI 응답 결과 저장
- **Shops**: 상점 아이템 목록
- **Purchases**: 아이템 구매 내역
- **SystemLogs**: 시스템/에러 로그

---

## 2. 테이블 구조

### 2.1 Users
| 컬럼명        | 타입        | 설명                          |
|---------------|------------|-------------------------------|
| user_id       | BIGINT PK  | 디스코드 유저 ID              |
| username      | VARCHAR    | 유저명 (태그 포함)            |
| created_at    | TIMESTAMP  | 첫 사용 시각                  |

### 2.2 Servers
| 컬럼명        | 타입        | 설명                          |
|---------------|------------|-------------------------------|
| server_id     | BIGINT PK  | 디스코드 서버 ID              |
| name          | VARCHAR    | 서버 이름                     |
| owner_id      | BIGINT FK  | 서버 소유자 (Users.user_id)   |
| created_at    | TIMESTAMP  | 등록 시각                     |

### 2.3 UserStats
| 컬럼명        | 타입        | 설명                                 |
|---------------|------------|--------------------------------------|
| id            | BIGINT PK  | 고유 ID                              |
| user_id       | BIGINT FK  | 대상 유저                            |
| server_id     | BIGINT FK  | 해당 서버                            |
| kizuna_rank   | INT        | 인연 랭크 (키즈나 랭크)              |
| exp           | INT        | 랭크 경험치                          |
| last_active   | TIMESTAMP  | 마지막 활동 시간                     |

### 2.4 ChatLogs
| 컬럼명        | 타입        | 설명                              |
|---------------|------------|-----------------------------------|
| chat_id       | BIGINT PK  | 고유 ID                           |
| user_id       | BIGINT FK  | 발신 유저                         |
| server_id     | BIGINT FK  | 소속 서버                         |
| message       | TEXT       | 유저 입력 메시지                  |
| created_at    | TIMESTAMP  | 메시지 시간                       |

### 2.5 AIResponses
| 컬럼명        | 타입        | 설명                              |
|---------------|------------|-----------------------------------|
| response_id   | BIGINT PK  | 고유 ID                           |
| chat_id       | BIGINT FK  | 관련 유저 메시지                  |
| model_name    | VARCHAR    | 사용 모델 (예: gpt-4, llama-2)   |
| response      | TEXT       | AI 응답                           |
| tokens_used   | INT        | 토큰 사용량                       |
| created_at    | TIMESTAMP  | 응답 시각                         |
| quality_score | FLOAT      | 품질 평가 점수 (필요 시)          |

### 2.6 Shops
| 컬럼명        | 타입        | 설명                              |
|---------------|------------|-----------------------------------|
| item_id       | BIGINT PK  | 아이템 고유 ID                    |
| name          | VARCHAR    | 아이템 이름                       |
| description   | TEXT       | 아이템 설명                       |
| price         | INT        | 가격                              |

### 2.7 Purchases
| 컬럼명        | 타입        | 설명                              |
|---------------|------------|-----------------------------------|
| purchase_id   | BIGINT PK  | 구매 ID                           |
| user_id       | BIGINT FK  | 구매자                            |
| item_id       | BIGINT FK  | 구매 아이템                       |
| created_at    | TIMESTAMP  | 구매 시각                         |

### 2.8 SystemLogs
| 컬럼명        | 타입        | 설명                              |
|---------------|------------|-----------------------------------|
| log_id        | BIGINT PK  | 로그 ID                           |
| log_type      | VARCHAR    | 로그 타입 (에러, 요청, API 등)    |
| details       | TEXT       | 상세 내용                         |
| created_at    | TIMESTAMP  | 기록 시각                         |

---

## 3. 확장 가능성
- **Feedback 테이블**: 유저가 AI 응답에 👍👎 남긴 경우 기록
- **CachedResponses**: 반복 질문 캐싱 테이블 (비용 최적화)
- **SessionMemory**: 장기 기억 관리 테이블